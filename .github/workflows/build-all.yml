name: Build sing-box (Android, Windows, Linux)

on:
  workflow_dispatch:
    inputs:
      sing_box_repo:
        description: 'sing-box repository'
        required: true
        default: 'reF1nd/sing-box'
      sing_box_branch:
        description: 'sing-box branch'
        required: true
        default: 'reF1nd-dev'
      version:
        description: 'Version (e.g. 1.13.0-alpha.27.reF1nd)'
        required: true

env:
  TAGS_BASE: 'with_gvisor,with_quic,with_dhcp,with_wireguard,with_utls,with_acme,with_clash_api,with_tailscale,with_ccm,with_ocm,badlinkname,tfogo_checklinkname0'
  TAGS_ANDROID: 'with_gvisor,with_quic,with_dhcp,with_wireguard,with_utls,with_acme,with_clash_api,with_tailscale,with_ccm,with_ocm'

jobs:
  build_linux:
    name: Build Linux binary
    runs-on: ubuntu-latest
    steps:
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ^1.25.5
          cache: false

      - name: Clone sing-box
        run: |
          git clone -b ${{ github.event.inputs.sing_box_branch }} \
            https://github.com/${{ github.event.inputs.sing_box_repo }}.git \
            sing-box
          cd sing-box
          git fetch --tags https://github.com/SagerNet/sing-box.git --force

      - name: Set tag
        run: |
          cd sing-box
          git tag v${{ github.event.inputs.version }} -f

      - name: Build
        run: |
          cd sing-box
          mkdir -p dist
          go build -v -trimpath -o dist/sing-box \
            -tags "${TAGS_BASE},with_purego" \
            -ldflags '-s -buildid= -X github.com/sagernet/sing-box/constant.Version=${{ github.event.inputs.version }} -checklinkname=0' \
            ./cmd/sing-box
        env:
          CGO_ENABLED: '0'
          GOOS: linux
          GOARCH: amd64
          GOAMD64: v3

      - name: Rename
        run: |
          cd sing-box/dist
          mv sing-box sing-box-${{ github.event.inputs.version }}-linux-amd64v3

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-linux
          path: sing-box/dist/*

  build_windows:
    name: Build Windows binary
    runs-on: windows-latest
    steps:
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ^1.25.5

      - name: Clone sing-box
        run: |
          git clone -b ${{ github.event.inputs.sing_box_branch }} `
            https://github.com/${{ github.event.inputs.sing_box_repo }}.git `
            sing-box
          cd sing-box
          git fetch --tags https://github.com/SagerNet/sing-box.git --force

      - name: Set tag
        run: |
          cd sing-box
          git tag v${{ github.event.inputs.version }} -f

      - name: Build
        run: |
          $TAGS = "${{ env.TAGS_BASE }},with_purego"
          cd sing-box
          mkdir -p dist
          go build -v -trimpath -o dist/sing-box.exe -tags "$TAGS" `
            -ldflags "-s -buildid= -X github.com/sagernet/sing-box/constant.Version=${{ github.event.inputs.version }} -checklinkname=0" `
            ./cmd/sing-box
        env:
          CGO_ENABLED: "0"
          GOOS: windows
          GOARCH: amd64

      - name: Archive
        run: |
          cd sing-box/dist
          $DIR_NAME = "sing-box-${{ github.event.inputs.version }}-windows-amd64v3"
          mkdir $DIR_NAME
          Copy-Item "sing-box.exe" $DIR_NAME
          Compress-Archive -Path $DIR_NAME -DestinationPath "$DIR_NAME.zip"
          Remove-Item -Recurse $DIR_NAME
          Remove-Item sing-box.exe

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-windows
          path: sing-box/dist/*

  build_android:
    name: Build Android
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
    steps:
      - name: Setup OpenJDK
        run: |
          sudo apt update && sudo apt install -y openjdk-17-jdk-headless
          java --version

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ^1.25.5
          cache: false

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r28

      - name: Checkout sing-box
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.sing_box_repo }}
          ref: ${{ github.event.inputs.sing_box_branch }}
          path: sing-box
          fetch-depth: 0
          submodules: 'recursive'

      - name: Fetch upstream tags
        run: |
          cd sing-box
          git fetch --tags https://github.com/SagerNet/sing-box.git --force

      - name: Set tag
        run: |
          cd sing-box
          git tag v${{ github.event.inputs.version }} -f

      - name: Update Android client to compatible version
        run: |
          cd sing-box/clients/android
          git fetch origin dev:dev 2>/dev/null || git fetch origin main:main 2>/dev/null || true
          git checkout dev 2>/dev/null || git checkout main 2>/dev/null || echo "Using current submodule commit"

      - name: Install gomobile
        run: |
          cd sing-box
          make lib_install
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Build libbox.aar
        run: |
          cd sing-box
          export PATH="$PATH:$(go env GOPATH)/bin"
          gomobile bind -v -androidapi 21 -javapkg=io.nekohasekai -libname=box -tags="${TAGS_ANDROID}" -ldflags="-X github.com/sagernet/sing-box/constant.Version=${{ github.event.inputs.version }} -buildid= -checklinkname=0" ./experimental/libbox
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

      - name: Verify libbox.aar
        run: |
          cd sing-box
          if [ ! -f "libbox.aar" ]; then
            echo "Error: libbox.aar not found!"
            exit 1
          fi
          echo "libbox.aar size: $(ls -lh libbox.aar)"

      - name: Prepare Android client
        run: |
          cd sing-box
          mkdir -p clients/android/app/libs
          cp libbox.aar clients/android/app/libs/

      - name: Update package name and ABI filter
        run: |
          cd sing-box/clients/android
          sed -i '/applicationId/s/io\.nekohasekai\.sfa/io.quic_go.sfa/' app/build.gradle
          sed -i '/defaultConfig {/a\        ndk {\n            abiFilters "arm64-v8a"\n        }' app/build.gradle

      - name: Decode Keystore
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE_FILE }}" | base64 -d > sing-box/clients/android/app/release.keystore

      - name: Build APK
        run: |
          cd sing-box/clients/android
          
          VERSION="${{ github.event.inputs.version }}"
          VERSION_CODE=$(date +%Y%m%d%H)
          
          echo "VERSION_NAME=$VERSION" > version.properties
          echo "VERSION_CODE=$VERSION_CODE" >> version.properties
          
          chmod +x gradlew
          
          ./gradlew :app:assembleOtherRelease \
            -Pandroid.injected.signing.store.file=$(pwd)/app/release.keystore \
            -Pandroid.injected.signing.store.password="${{ secrets.RELEASE_KEYSTORE_PASSWORD }}" \
            -Pandroid.injected.signing.key.alias="${{ secrets.RELEASE_KEY_ALIAS }}" \
            -Pandroid.injected.signing.key.password="${{ secrets.RELEASE_KEY_PASSWORD }}"
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

      - name: Rename APK
        run: |
          cd sing-box/clients/android/app/build/outputs/apk/other/release
          find . -type f -name "*.apk" ! -name "*arm64-v8a*" -delete 2>/dev/null || true
          APK_FILE=$(ls *arm64-v8a*.apk 2>/dev/null | head -n 1 || ls *.apk 2>/dev/null | head -n 1)
          TARGET_NAME="SFA-${{ github.event.inputs.version }}-foss-arm64-v8a.apk"
          if [ -n "$APK_FILE" ]; then
            if [ "$APK_FILE" != "$TARGET_NAME" ]; then
              mv "$APK_FILE" "$TARGET_NAME"
            fi
          else
            echo "Error: No APK found!"
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: sing-box/clients/android/app/build/outputs/apk/other/release/*.apk

  publish:
    name: Publish Release
    needs: [build_linux, build_windows, build_android]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Delete older releases
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 0
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: ${{ github.event.inputs.version }}
          body: |
            üìù Release Notes
            Fixes and improvements
          files: dist/*
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
