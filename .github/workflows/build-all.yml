name: Build sing-box (Android, Windows, Linux)

on:
  workflow_dispatch:
    inputs:
      sing_box_repo:
        description: 'sing-box repository'
        required: true
        default: 'reF1nd/sing-box'
      sing_box_branch:
        description: 'sing-box branch'
        required: true
        default: 'reF1nd-dev'
      version:
        description: 'Version (e.g. 1.13.0-alpha.27.reF1nd)'
        required: true

env:
  TAGS: 'with_gvisor,with_quic,with_dhcp,with_wireguard,with_utls,with_acme,with_clash_api,with_tailscale,with_ccm,badlinkname,tfogo_checklinkname0'

jobs:
  build_binary:
    name: Build binary
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - { os: windows, arch: amd64, goamd64: v3, ext: .exe }
          - { os: linux, arch: amd64, goamd64: v3, ext: '' }
    steps:
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ^1.25.4
          cache: false

      - name: Clone sing-box
        run: |
          git clone -b ${{ github.event.inputs.sing_box_branch }} \
            https://github.com/${{ github.event.inputs.sing_box_repo }}.git \
            sing-box
          cd sing-box
          git fetch --tags https://github.com/SagerNet/sing-box.git --force

      - name: Set tag
        run: |
          cd sing-box
          git tag v${{ github.event.inputs.version }} -f

      - name: Build
        run: |
          cd sing-box
          mkdir -p dist
          go build -v -trimpath -o dist/sing-box${{ matrix.ext }} \
            -tags "${TAGS}" \
            -ldflags '-s -w -buildid= -X github.com/sagernet/sing-box/constant.Version=${{ github.event.inputs.version }} -checklinkname=0' \
            ./cmd/sing-box
        env:
          CGO_ENABLED: '0'
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          GOAMD64: ${{ matrix.goamd64 }}

      - name: Rename
        run: |
          cd sing-box/dist
          mv sing-box${{ matrix.ext }} sing-box-${{ github.event.inputs.version }}-${{ matrix.os }}-${{ matrix.arch }}v3${{ matrix.ext }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.os }}-${{ matrix.arch }}v3
          path: sing-box/dist/*

  build_android:
    name: Build Android
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sing-box-for-android
        uses: actions/checkout@v4
        with:
          repository: SagerNet/sing-box-for-android
          path: sing-box-for-android

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ^1.25.4
          cache: false

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r28

      - name: Clone sing-box
        run: |
          git clone -b ${{ github.event.inputs.sing_box_branch }} \
            https://github.com/${{ github.event.inputs.sing_box_repo }}.git \
            sing-box
          cd sing-box
          git fetch --tags https://github.com/SagerNet/sing-box.git --force

      - name: Install gomobile
        run: |
          cd sing-box
          make lib_install
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Build libbox.aar
        run: |
          cd sing-box
          gomobile init
          
          VERSION="${{ github.event.inputs.version }}"
          git tag -f "v${VERSION}"
          
          go mod edit -replace github.com/sagernet/sing-box=./
          go mod tidy
          
          go run ./cmd/internal/build_libbox -target android
          
          mkdir -p ../sing-box-for-android/app/libs
          cp libbox.aar ../sing-box-for-android/app/libs/
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

      - name: Update package name
        run: |
          cd sing-box-for-android
          sed -i '/applicationId/s/io\.nekohasekai\.sfa/io.quic_go.sfa/' app/build.gradle

      - name: Decode Keystore
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE_FILE }}" | base64 -d > sing-box-for-android/app/release.keystore

      - name: Build APK (signed release)
        run: |
          cd sing-box-for-android
          
          VERSION="${{ github.event.inputs.version }}"
          VERSION_CODE=$(date +%Y%m%d%H)
          
          echo "VERSION_NAME=$VERSION" > version.properties
          echo "VERSION_CODE=$VERSION_CODE" >> version.properties
          
          chmod +x gradlew
          
          ./gradlew :app:assembleOtherRelease \
            -Pandroid.injected.build.abi.filters=arm64-v8a \
            -Pandroid.injected.signing.store.file=$(pwd)/app/release.keystore \
            -Pandroid.injected.signing.store.password="${{ secrets.RELEASE_KEYSTORE_PASSWORD }}" \
            -Pandroid.injected.signing.key.alias="${{ secrets.RELEASE_KEY_ALIAS }}" \
            -Pandroid.injected.signing.key.password="${{ secrets.RELEASE_KEY_PASSWORD }}"
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

      - name: Rename APK
        run: |
          cd sing-box-for-android/app/build/outputs/apk/other/release
          mv *.apk "SFA-${{ github.event.inputs.version }}-foss-arm64-v8a.apk"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: sing-box-for-android/app/build/outputs/apk/other/release/*.apk

  publish:
    name: Publish Release
    needs: [build_binary, build_android]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Delete older releases
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 0
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: Sing-box ${{ github.event.inputs.version }}
          body: |
            üìù Release Notes
            Fixes and improvements
          files: dist/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
